{% extends 'schools/base_dash.html' %}

{% block content %}
<div>
    <!-- Header Card -->
    <div class="card card-outline card-primary">
        <div id="cardHeader" class="card-header bg-primary text-white">
            <h3 class="card-title">
                <i class="fas fa-table"></i> Generate Broadsheet
            </h3>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <form id="broadsheetFilterForm" method="GET">
                {% csrf_token %}
                <div class="row mb-3">
                    <!-- Session -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="session">Session</label>
                            <select id="session" name="session" class="form-control" required>
                                <option value="">Select Session</option>
                            </select>
                        </div>
                    </div>
                    <!-- Term -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="term">Term</label>
                            <select id="term" name="term" class="form-control" required disabled>
                                <option value="">Select Term</option>
                            </select>
                        </div>
                    </div>
                    <!-- Branch -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="branch">Branch</label>
                            <select id="branch" name="branch" class="form-control" required disabled>
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Classes -->
                <div class="form-group mb-3">
                    <label for="classes">Class(es)</label>
                    <div id="classes" class="bg-light p-3 rounded">
                        <!-- Classes will be dynamically populated -->
                    </div>
                </div>

                <button type="button" class="btn btn-primary" id="filterButton">Generate Broadsheet</button>
            </form>
            <hr>

            <!-- Broadsheet Table -->
            <div class="table-responsive" id="broadsheetContainer" style="overflow-y: auto; max-height: 500px;">
                <!-- Broadsheet data will be populated dynamically -->
            </div>

            <!-- Action Buttons -->
            <div class="text-center mt-3 d-none" id="actionButtons">
                <button type="button" class="btn btn-success" id="publishBroadsheetButton">Publish Broadsheet</button>
                <button type="button" class="btn btn-primary" id="printBroadsheetButton">Print Broadsheet</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="alertsModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div id="modalHeader" class="modal-header">
                <h5 id="modalTitle" class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="modalBody" class="modal-body"></div>
            <div id="modalFooter" class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- CSS for Validation Feedback -->
<style>
    .is-invalid {
        border-color: #dc3545;
    }

    .is-valid {
        border-color: #28a745;
    }
</style>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const modalElement = new bootstrap.Modal(document.getElementById("alertsModal"));
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalHeader = document.getElementById("modalHeader");
    const modalFooter = document.getElementById("modalFooter");

    const shortCode = "{{ school.short_code }}";
    const sessionSelect = document.getElementById("session");
    const termSelect = document.getElementById("term");
    const branchSelect = document.getElementById("branch");
    const classesContainer = document.getElementById("classes");
    const broadsheetContainer = document.getElementById("broadsheetContainer");
    const filterButton = document.getElementById("filterButton");
    const actionButtons = document.getElementById("actionButtons");
    const publishBroadsheetButton = document.getElementById("publishBroadsheetButton");
    const printBroadsheetButton = document.getElementById("printBroadsheetButton");

    // Utility function for alerts
    function showModal(type, title, message) {
        modalTitle.textContent = title;
        modalBody.textContent = message;

        modalHeader.className = `modal-header bg-${type} text-white`;
        modalFooter.className = `modal-footer bg-${type} text-white`;
        modalElement.show();
    }

    // Fetch sessions
    fetch(`/broadsheet/${shortCode}/get-sessions/`)
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                data.sessions.forEach(session => {
                    const option = document.createElement("option");
                    option.value = session.id;
                    option.textContent = session.session_name;
                    sessionSelect.appendChild(option);
                });
            }
        });

    // Fetch terms
    sessionSelect.addEventListener("change", function () {
        termSelect.disabled = true;
        termSelect.innerHTML = '<option value="">Select Term</option>';
        if (sessionSelect.value) {
            fetch(`/broadsheet/${shortCode}/get-terms/${sessionSelect.value}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.terms) {
                        termSelect.disabled = false;
                        data.terms.forEach(term => {
                            const option = document.createElement("option");
                            option.value = term.id;
                            option.textContent = term.term_name;
                            termSelect.appendChild(option);
                        });
                    }
                });
        }
    });

    // Fetch branches
    termSelect.addEventListener("change", function () {
        branchSelect.disabled = true;
        branchSelect.innerHTML = '<option value="">Select Branch</option>';
        if (termSelect.value) {
            fetch(`/broadsheet/${shortCode}/get-branches/`)
                .then(response => response.json())
                .then(data => {
                    if (data.branches) {
                        branchSelect.disabled = false;
                        data.branches.forEach(branch => {
                            const option = document.createElement("option");
                            option.value = branch.id;
                            option.textContent = branch.branch_name;
                            branchSelect.appendChild(option);
                        });
                    }
                });
        }
    });

    // Fetch classes
    branchSelect.addEventListener("change", function () {
        classesContainer.innerHTML = '';
        if (branchSelect.value) {
            fetch(`/broadsheet/${shortCode}/get-classes/${branchSelect.value}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.classes) {
                        data.classes.forEach(cls => {
                            const div = document.createElement("div");
                            div.classList.add("form-check");
                            div.innerHTML = `
                                <input class="form-check-input" type="checkbox" value="${cls.id}">
                                <label class="form-check-label">${cls.name}</label>
                            `;
                            classesContainer.appendChild(div);
                        });
                    }
                });
        }
    });
    
    // Filter students for comments
    filterButton.addEventListener("click", function () {
        const session = sessionSelect.value;
        const term = termSelect.value;
        const branch = branchSelect.value;
        const classes = Array.from(classesContainer.querySelectorAll("input:checked")).map(cb => cb.value);

        if (!session || !term || !branch || classes.length === 0) {
            showModal("warning", "Incomplete Fields", "Please fill in all fields.");
            return;
        }

        fetch(`/comments/${shortCode}/get-comments/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({ session, term, branch, classes }),
        })
            .then(response => response.json())
            .then(data => {
                commentsTableBody.innerHTML = "";

                if (data.students) {
                    data.students.forEach(student => {
                        const row = document.createElement("tr");

                        const nameCell = document.createElement("td");
                        nameCell.textContent = `${student.last_name} ${student.first_name}`;
                        row.appendChild(nameCell);

                        const commentCell = document.createElement("td");
                        const textarea = document.createElement("textarea");
                        textarea.name = `comment_${student.id}`;
                        textarea.value = student.comment_text || "";
                        textarea.classList.add("form-control");
                        commentCell.appendChild(textarea);
                        row.appendChild(commentCell);

                        commentsTableBody.appendChild(row);
                    });
                } else {
                    commentsTableBody.innerHTML = `<tr><td colspan="2">No students found.</td></tr>`;
                }
            });
    });

    // Save comments
    submitCommentsButton.addEventListener("click", function () {
        const session = sessionSelect.value;
        const term = termSelect.value;
        const branch = branchSelect.value;
        const classes = Array.from(classesContainer.querySelectorAll("input:checked")).map(cb => cb.value);

        let isValid = true;
        const comments = Array.from(commentsTableBody.querySelectorAll("tr")).map(row => {
            const textarea = row.querySelector("textarea");
            const studentId = textarea.name.split("_")[1];
            const commentText = textarea.value.trim();

            if (!commentText) {
                textarea.classList.add("is-invalid");
                isValid = false;
            } else {
                textarea.classList.remove("is-invalid");
                textarea.classList.add("is-valid");
            }

            return { student_id: studentId, comment_text: commentText };
        });

        if (!isValid) {
            showModal("warning", "Validation Error", "Please fill out all comments before saving.");
            return;
        }

        fetch(`/comments/${shortCode}/save-comments/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({ session, term, branch, classes, comments }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showModal("success", "Comments Saved", "All comments have been successfully saved!");
                    commentsTableBody.querySelectorAll("textarea").forEach(textarea => {
                        textarea.classList.remove("is-valid");
                    });
                } else {
                    showModal("error", "Error Saving Comments", data.error || "An error occurred.");
                }
            });
    });
});

</script>
{% endblock %}

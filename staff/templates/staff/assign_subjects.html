{% extends "adminlte/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="card">
    <section class="card-body">
        <div class="card mx-auto" style="margin:0px;">
            <div class="card-header bg-primary text-white">
                <h1 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-check-fill" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L12.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
                        <path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                      </svg>
                    Assign Subjects and Classes for {{ staff.user.first_name }} {{ staff.user.last_name }}
                </h1>
            </div>

            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="assignSubjectsForm">
                    {% csrf_token %}
                    
                    <!-- Branch Selection -->
                    <div class="card mb-3" id="branchSelection">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-buildings-fill" viewBox="0 0 16 16">
                                    <path d="M15 .5a.5.5 0 0 0-.724-.447l-8 4A.5.5 0 0 0 6 4.5v3.14L.342 9.526A.5.5 0 0 0 0 10v5.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V14h1v1.5a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5zM2 11h1v1H2zm2 0h1v1H4zm-1 2v1H2v-1zm1 0h1v1H4zm9-10v1h-1V3zM8 5h1v1H8zm1 2v1H8V7zM8 9h1v1H8zm2 0h1v1h-1zm-1 2v1H8v-1zm1 0h1v1h-1zm3-2v1h-1V9zm-1 2h1v1h-1zm-2-4h1v1h-1zm3 0v1h-1V7zm-2-2v1h-1V5zm1 0h1v1h-1z"/>
                                  </svg>
                                Select Branch
                            </h3>
                        </div>
                        <div class="card-body bg-light">
                            <div class="form-group">
                                {{ form.branch|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Subject Selection -->
                    <div class="card mb-3" id="subjectSelection" style="display: none;">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journals" viewBox="0 0 16 16">
                                    <path d="M5 0h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2 2 2 0 0 1-2 2H3a2 2 0 0 1-2-2h1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1H1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v9a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1H3a2 2 0 0 1 2-2"/>
                                    <path d="M1 6v-.5a.5.5 0 0 1 1 0V6h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V9h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 2.5v.5H.5a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1H2v-.5a.5.5 0 0 0-1 0"/>
                                  </svg>
                                Select Subject
                            </h3>
                        </div>
                        <div class="card-body bg-light">
                            <div class="form-group">
                                {{ form.subject|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Classes Selection -->
                    <div class="card mb-3" id="classesSelection" style="display: none;">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stack" viewBox="0 0 16 16">
                                    <path d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.6.6 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.6.6 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.6.6 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535z"/>
                                    <path d="m14.12 6.576 1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.6.6 0 0 1-.534 0L.165 7.968a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0z"/>
                                  </svg>
                                Select Classes
                            </h3>
                        </div>
                        <div class="card-body bg-light">
                            <div class="form-group">
                                {{ form.classes|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Loader -->
                    <div id="loader" style="display: none;" class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="50" height="50">
                            <rect fill="#1F00FF" stroke="#1F00FF" stroke-width="15" width="30" height="30" x="25" y="85" data-darkreader-inline-stroke="" style="--darkreader-inline-stroke: #ff6dff; --darkreader-inline-fill: #ff6dff;" data-darkreader-inline-fill="">
                                <animate attributeName="opacity" calcMode="spline" dur="2" values="1;0;1;" keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.4"></animate>
                            </rect>
                            <rect fill="#1F00FF" stroke="#1F00FF" stroke-width="15" width="30" height="30" x="85" y="85" data-darkreader-inline-stroke="" style="--darkreader-inline-stroke: #ff6dff; --darkreader-inline-fill: #ff6dff;" data-darkreader-inline-fill="">
                                <animate attributeName="opacity" calcMode="spline" dur="2" values="1;0;1;" keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.2"></animate>
                            </rect>
                            <rect fill="#1F00FF" stroke="#1F00FF" stroke-width="15" width="30" height="30" x="145" y="85" data-darkreader-inline-stroke="" style="--darkreader-inline-stroke: #ff6dff; --darkreader-inline-fill: #ff6dff;" data-darkreader-inline-fill="">
                                <animate attributeName="opacity" calcMode="spline" dur="2" values="1;0;1;" keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="0"></animate>
                            </rect>
                        </svg>
                    </div>

                    <!-- Submit Button -->
                    <div class="card-footer d-flex justify-content-center" id="assignButton" style="display: none;">
                        <button type="submit" class="btn btn-primary" id="assignSubjectsButton">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-plus-fill" viewBox="0 0 16 16">
                                <path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1-1 1-1 1-1 1-1 1-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                                <path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5"/>
                              </svg>
                            Assign Subjects and Classes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const branchField = document.getElementById('id_branch');
        const subjectSection = document.getElementById('subjectSelection');
        const subjectField = document.getElementById('id_subject');
        const classesSection = document.getElementById('classesSelection');
        const assignButton = document.getElementById('assignButton');
        const loader = document.getElementById('loader');

        // Initially hide subject, classes sections, loader, and submit button
        subjectSection.style.display = 'none';
        classesSection.style.display = 'none';
        loader.style.display = 'none';
        assignButton.style.display = 'none';

        // Display subject section if branch is selected on page load
        if (branchField && branchField.value) {
            subjectSection.style.display = 'block';
            loader.style.display = 'none';
        }

        // Display classes section and show submit button if subject is selected on page load
        if (subjectField && subjectField.value) {
            classesSection.style.display = 'block';
            assignButton.style.display = 'block';
            loader.style.display = 'none';
        }

        // Auto-submit branch selection via AJAX
        if (branchField) {
            branchField.addEventListener('change', function() {
                loader.style.display = 'block';
                subjectSection.style.display = 'none';
                classesSection.style.display = 'none';
                assignButton.style.display = 'none';

                const formData = new FormData(document.getElementById('assignSubjectsForm'));
                fetch('', {
                    method: 'POST',
                    body: formData,
                }).then(response => response.text()).then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                }).catch(error => console.error('Error:', error));
            });
        }

        // Auto-submit subject selection via AJAX
        if (subjectField) {
            subjectField.addEventListener('change', function() {
                loader.style.display = 'block';
                classesSection.style.display = 'none';
                assignButton.style.display = 'none';

                const formData = new FormData(document.getElementById('assignSubjectsForm'));
                fetch('', {
                    method: 'POST',
                    body: formData,
                }).then(response => response.text()).then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                }).catch(error => console.error('Error:', error));
            });
        }

        // Show the submit button only when the classes section is visible
        if (classesSection.style.display === 'block') {
            assignButton.style.display = 'block';
        }
    });
</script>
{% endblock %}
